<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iDDI Concept</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://code.iconify.design/iconify-icon/1.0.2/iconify-icon.min.js"></script>
</head>
<body data-lang="ru" class="dark-mode">
    <div class="container">
        <!-- Верхний бар -->
        <div class="top-bar">
            <div class="logo">
                <a href="index.html"><img src="logo_inline.png" alt="Inline Telecom Solutions Logo"></a>
                <a href="index.html" class="idddi-title">iDDI</a>
            </div>
            <div class="controls">
                <div class="search-bar-container">
                    <div class="search-bar">
                        <iconify-icon icon="eva:search-outline"></iconify-icon>
                        <input type="text" id="page-search" data-lang-placeholder="ru:Поиск виджетов...|en:Search widgets..." autocomplete="off">
                    </div>
                    <div id="search-results" class="search-results-popup"></div>
                </div>
                <div class="theme-switch active">
                    <div class="knob"></div>
                </div>
                <div class="icon-btn" id="bell-icon">
                    <iconify-icon icon="clarity:notification-line"></iconify-icon>
                    <div id="notification-popup" class="popup-menu">
                        <span data-lang-text="ru:Новых уведомлений нет|en:No new notifications"></span>
                    </div>
                </div>
                <div class="icon-btn" id="lang-switcher">
                    <iconify-icon icon="emojione:flag-for-russia" id="lang-icon"></iconify-icon>
                </div>
                <div class="user-profile" id="user-avatar">
                     <div id="profile-dropdown" class="popup-menu profile-dropdown">
                        <a href="#" id="profile-settings-btn"><iconify-icon icon="clarity:cog-line"></iconify-icon><span data-lang-text="ru:Настройки профиля|en:Profile Settings"></span></a>
                        <a href="#"><iconify-icon icon="clarity:logout-line"></iconify-icon><span data-lang-text="ru:Выход|en:Logout"></span></a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Контекстная навигация: хлебные крошки и навигация по плиткам -->
        <div class="context-nav" style="display: none;">
            <div id="breadcrumbs"></div>
            <div id="tile-navigation" class="tile-nav"></div>
        </div>

        <!-- Основной контент -->
        <div class="main-content">
            <!-- Левая боковая панель -->
            <div class="sidebar">
                 <div class="main-menu-item active" data-target="dashboards-widgets">
                    <iconify-icon icon="pajamas:dashboard"></iconify-icon>
                    <span class="title" data-lang-text="ru:Дашборды|en:Dashboards"></span>
                </div>
                <div class="main-menu-item" data-target="idns-widgets">
                    <iconify-icon icon="eos-icons:dns"></iconify-icon>
                    <span class="title" data-lang-text="ru:iDNS|en:iDNS"></span>
                </div>
                <div class="main-menu-item" data-target="idhcp-widgets">
                    <iconify-icon icon="hugeicons:web-security"></iconify-icon>
                    <span class="title" data-lang-text="ru:iDHCP|en:iDHCP"></span>
                </div>
                <div class="main-menu-item" data-target="ipam-widgets">
                    <iconify-icon icon="eos-icons:ip"></iconify-icon>
                    <span class="title" data-lang-text="ru:IPAM|en:IPAM"></span>
                </div>
                <div class="main-menu-item" data-target="admin-widgets">
                    <iconify-icon icon="eos-icons:admin-outlined"></iconify-icon>
                    <span class="title" data-lang-text="ru:Панель Админа|en:Admin Panel"></span>
                </div>
                <div class="main-menu-item" data-target="settings-widgets">
                    <iconify-icon icon="ri:settings-4-fill"></iconify-icon>
                    <span class="title" data-lang-text="ru:Настройки|en:Settings"></span>
                </div>
                <div class="main-menu-item" data-target="logs-widgets">
                    <iconify-icon icon="octicon:log-16"></iconify-icon>
                    <span class="title" data-lang-text="ru:Логи|en:Logs"></span>
                </div>
            </div>

            <!-- Контейнер для переключаемых областей -->
            <div class="content-wrapper">
                <!-- Область с виджетами -->
                <div class="widget-area page-area active">
                    <!-- Группа виджетов для Dashboards -->
                    <div class="widget-group active" id="dashboards-widgets">
                        <div class="widget"><iconify-icon icon="mdi:format-list-checks"></iconify-icon><p data-lang-text="ru:Задачи|en:Tasks"></p></div>
                        <div class="widget"><iconify-icon icon="ic:outline-monitor"></iconify-icon><p data-lang-text="ru:Мониторинг|en:Monitoring"></p></div>
                        <div class="widget"><iconify-icon icon="clarity:settings-line"></iconify-icon><p data-lang-text="ru:Настройки виджетов|en:Widget settings"></p></div>
                    </div>
                    <!-- Группа виджетов для iDNS -->
                    <div class="widget-group" id="idns-widgets">
                        <div class="widget"><iconify-icon icon="mdi:dns-outline"></iconify-icon><p data-lang-text="ru:Зоны DNS|en:DNS Zones"></p></div>
                        <div class="widget"><iconify-icon icon="material-symbols:note-outline"></iconify-icon><p data-lang-text="ru:Ресурсные записи|en:Resource Records"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:shield-check-outline"></iconify-icon><p data-lang-text="ru:DNSSEC|en:DNSSEC"></p></div>
                        <div class="widget"><iconify-icon icon="iconoir:pc-firewall"></iconify-icon><p data-lang-text="ru:DNS Firewall|en:DNS Firewall"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:database-search-outline"></iconify-icon><p data-lang-text="ru:Журнал запросов|en:Query Log"></p></div>
                        <div class="widget"><iconify-icon icon="tabler:template"></iconify-icon><p data-lang-text="ru:Шаблоны зоны|en:Zone Templates"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:swap-horizontal-bold"></iconify-icon><p data-lang-text="ru:Переадресации|en:Forwarding"></p></div>
                        <div class="widget"><iconify-icon icon="carbon:subnet-acl-rules"></iconify-icon><p data-lang-text="ru:ACL|en:ACL"></p></div>
                        <div class="widget"><iconify-icon icon="akar-icons:statistic-up"></iconify-icon><p data-lang-text="ru:Статистика DNS|en:DNS Statistics"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:calendar-clock-outline"></iconify-icon><p data-lang-text="ru:Управление задачами (Расписание)|en:Task Management (Schedule)"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:server-network"></iconify-icon><p data-lang-text="ru:Управление сырыми конфигурациями узлов|en:Raw Node Configurations"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:format-list-checks"></iconify-icon><p data-lang-text="ru:Работа с записями правил|en:Rule Records Management"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:file-tree"></iconify-icon><p data-lang-text="ru:Управление схемами правил, директив и файлов конфигурации|en:Rule, Directive and Configuration File Schema Management"></p></div>
                        <div class="widget"><iconify-icon icon="akar-icons:statistic-up"></iconify-icon><p data-lang-text="ru:Метрики|en:Metrics"></p></div>
                        <div class="widget"><iconify-icon icon="carbon:network-enterprise"></iconify-icon><p data-lang-text="ru:Управление узлами|en:Node Management"></p></div>
                    </div>
                    <!-- Группа виджетов для iDHCP -->
                    <div class="widget-group" id="idhcp-widgets">
                        <div class="widget"><iconify-icon icon="bx:layer"></iconify-icon><p data-lang-text="ru:Диапазоны|en:Ranges"></p></div>
                        <div class="widget"><iconify-icon icon="bx:time-five"></iconify-icon><p data-lang-text="ru:Аренды|en:Leases"></p></div>
                        <div class="widget"><iconify-icon icon="clarity:host-line"></iconify-icon><p data-lang-text="ru:Резервации|en:Reservations"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:cog-outline"></iconify-icon><p data-lang-text="ru:Опции DHCP|en:DHCP Options"></p></div>
                        <div class="widget"><iconify-icon icon="fluent:database-plug-connected-20-regular"></iconify-icon><p data-lang-text="ru:Отказоустойчивость|en:Failover"></p></div>
                        <div class="widget"><iconify-icon icon="cib:matrix"></iconify-icon><p data-lang-text="ru:Политики аренды|en:Lease Policies"></p></div>
                        <div class="widget"><iconify-icon icon="tabler:route-2"></iconify-icon><p data-lang-text="ru:Relay-агенты|en:Relay Agents"></p></div>
                        <div class="widget"><iconify-icon icon="akar-icons:statistic-up"></iconify-icon><p data-lang-text="ru:Статистика DHCP|en:DHCP Statistics"></p></div>
                    </div>
                    <!-- Группа виджетов для IPAM -->
                    <div class="widget-group" id="ipam-widgets">
                        <div class="widget"><iconify-icon icon="carbon:network-2"></iconify-icon><p data-lang-text="ru:Схемы сети|en:Network views"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:lan-pending"></iconify-icon><p data-lang-text="ru:VLANs|en:VLANs"></p></div>
                        <div class="widget"><iconify-icon icon="clarity:vm-line"></iconify-icon><p data-lang-text="ru:Superhost|en:Superhost"></p></div>
                        <div class="widget"><iconify-icon icon="fluent:document-data-24-regular"></iconify-icon><p data-lang-text="ru:Доп. атрибуты|en:Extensible attributes"></p></div>
                        <div class="widget"><iconify-icon icon="carbon:report"></iconify-icon><p data-lang-text="ru:Отчеты|en:Reports"></p></div>
                    </div>
                    <!-- Группа виджетов для Admin Panel -->
                    <div class="widget-group" id="admin-widgets">
                        <div class="widget"><iconify-icon icon="clarity:users-line"></iconify-icon><p data-lang-text="ru:Пользователи|en:Users"></p></div>
                        <div class="widget"><iconify-icon icon="clarity:group-line"></iconify-icon><p data-lang-text="ru:Группы|en:Groups"></p></div>
                        <div class="widget"><iconify-icon icon="fluent:key-24-regular"></iconify-icon><p data-lang-text="ru:Права|en:Permissions"></p></div>
                        <div class="widget"><iconify-icon icon="clarity:assign-user-line"></iconify-icon><p data-lang-text="ru:Роли|en:Roles"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:shield-key-outline"></iconify-icon><p data-lang-text="ru:Политика аутентификации|en:Auth Policy"></p></div>
                        <div class="widget"><iconify-icon icon="carbon:server-proxy"></iconify-icon><p data-lang-text="ru:Серверы аутентификации|en:Auth Servers"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:account-key-outline"></iconify-icon><p data-lang-text="ru:Пользователи SNMPv3|en:SNMPv3 Users"></p></div>
                        <div class="widget"><iconify-icon icon="fluent:document-search-24-regular"></iconify-icon><p data-lang-text="ru:Журнал аудита|en:Audit Log"></p></div>
                    </div>
                    <!-- Группа виджетов для Settings -->
                    <div class="widget-group" id="settings-widgets">
                        <div class="widget"><iconify-icon icon="carbon:document-preliminary"></iconify-icon><p data-lang-text="ru:Распространение файлов|en:File Distribution"></p></div>
                        <div class="widget"><iconify-icon icon="clarity:notification-outline-badged"></iconify-icon><p data-lang-text="ru:Уведомления|en:Notifications"></p></div>
                        <div class="widget"><iconify-icon icon="ant-design:api-outlined"></iconify-icon><p data-lang-text="ru:Интеграции|en:Integrations"></p></div>
                        <div class="widget"><iconify-icon icon="carbon:update-now"></iconify-icon><p data-lang-text="ru:Обновления|en:Updates"></p></div>
                        <div class="widget"><iconify-icon icon="ic:outline-backup"></iconify-icon><p data-lang-text="ru:Резервное копирование|en:Backup"></p></div>
                    </div>
                    <!-- Группа виджетов для Logs -->
                    <div class="widget-group" id="logs-widgets">
                        <div class="widget"><iconify-icon icon="carbon:document-export"></iconify-icon><p data-lang-text="ru:Экспорт логов|en:Export logs"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:file-document-outline"></iconify-icon><p data-lang-text="ru:Syslog|en:Syslog"></p></div>
                        <div class="widget"><iconify-icon icon="mdi:shield-lock-outline"></iconify-icon><p data-lang-text="ru:События безопасности|en:Security Events"></p></div>
                    </div>
                </div>

                 <!-- Область для детального просмотра виджета -->
                <div id="widget-detail-area" class="page-area">
                    <!-- Сюда будет загружаться контент виджета -->
                </div>

                <!-- Страница настроек профиля -->
                <div id="profile-page" class="page-area">
                    <div class="profile-menu">
                        <a href="#" class="profile-menu-item active" data-target="profile-main-data-section">Основные данные</a>
                        <a href="#" class="profile-menu-item" data-target="profile-interface-section">Интерфейс</a>
                        <a href="#" class="profile-menu-item" data-target="profile-history-section">История авторизаций</a>
                    </div>
                    <div class="profile-content">
                        <div id="profile-main-data-section" class="profile-section active">
                            <h2><span data-lang-text="ru:Основные данные|en:Main Data"></span></h2>
                            <div class="form-group">
                                <label for="fullName" data-lang-text="ru:Имя пользователя|en:Full Name"></label>
                                <input type="text" id="fullName" value="Ivan I." readonly>
                            </div>
                            <div class="form-group">
                                <label data-lang-text="ru:Тип учётной записи|en:Account Type"></label>
                                <span class="read-only-field" data-lang-text="ru:Администратор|en:Administrator"></span>
                            </div>
                            <div class="form-group">
                                <label data-lang-text="ru:Группа|en:Group"></label>
                                <span class="read-only-field" data-lang-text="ru:Отдел разработки|en:Development Department"></span>
                            </div>
                            <div class="form-group">
                                <label for="email" data-lang-text="ru:E-mail|en:E-mail"></label>
                                <input type="email" id="email" value="ivan.i@example.com">
                            </div>
                            <div class="form-group">
                                <button id="changePasswordBtn" class="btn" data-lang-text="ru:Смена пароля|en:Change Password"></button>
                            </div>

                            <div id="passwordChangeForm" class="hidden password-form">
                                <h3><span data-lang-text="ru:Смена пароля|en:Change Password"></span></h3>
                                <div class="form-group">
                                    <label for="currentPassword" data-lang-text="ru:Текущий пароль|en:Current Password"></label>
                                    <input type="password" id="currentPassword">
                                </div>
                                <div class="form-group">
                                    <label for="newPassword" data-lang-text="ru:Новый пароль|en:New Password"></label>
                                    <input type="password" id="newPassword">
                                    <div class="password-strength-indicator">
                                        <div class="strength-bar"></div>
                                        <div class="strength-bar"></div>
                                        <div class="strength-bar"></div>
                                        <div class="strength-bar"></div>
                                    </div>
                                    <span class="password-hint" data-lang-text="ru:Пароль должен содержать не менее 8 символов, включая заглавные и строчные буквы, цифры и спецсимволы.|en:Password must be at least 8 characters long, including uppercase and lowercase letters, numbers, and special characters."></span>
                                </div>
                                <div class="form-group">
                                    <label for="confirmPassword" data-lang-text="ru:Подтверждение пароля|en:Confirm Password"></label>
                                    <input type="password" id="confirmPassword">
                                </div>
                                <div class="form-actions">
                                    <button class="btn btn-primary" data-lang-text="ru:Сохранить пароль|en:Save Password" style="padding: 6px 12px; font-size: 13px;"></button>
                                    <button class="btn btn-secondary" data-lang-text="ru:Отмена|en:Cancel" style="padding: 6px 12px; font-size: 13px;"></button>
                                </div>
                            </div>
                        </div>
                        <div id="profile-interface-section" class="profile-section">
                            <h2><span data-lang-text="ru:Настройки интерфейса|en:Interface Settings"></span></h2>
                            <div class="form-group">
                                <label for="homeDashboard" data-lang-text="ru:Домашний дашборд|en:Home Dashboard"></label>
                                <select id="homeDashboard">
                                    <option value="dashboards-widgets" data-lang-text="ru:Дашборды|en:Dashboards"></option>
                                    <option value="idns-widgets" data-lang-text="ru:iDNS|en:iDNS"></option>
                                    <option value="idhcp-widgets" data-lang-text="ru:iDHCP|en:iDHCP"></option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="widgetLimit" data-lang-text="ru:Лимит виджетов|en:Widget Limit"></label>
                                <input type="number" id="widgetLimit" min="5" max="20" value="10">
                                <span class="password-hint" data-lang-text="ru:Максимум элементов на дашборде (от 5 до 20)|en:Maximum elements on dashboard (from 5 to 20)"></span>
                            </div>
                            <div class="form-group">
                                <label for="timeZone" data-lang-text="ru:Часовой пояс|en:Time Zone"></label>
                                <select id="timeZone">
                                    <option value="Europe/Moscow" data-lang-text="ru:Москва (UTC+3)|en:Moscow (UTC+3)"></option>
                                    <option value="America/New_York" data-lang-text="ru:Нью-Йорк (UTC-5)|en:New York (UTC-5)"></option>
                                    <option value="Asia/Tokyo" data-lang-text="ru:Токио (UTC+9)|en:Tokyo (UTC+9)"></option>
                                </select>
                                <span id="currentTime" class="password-hint"></span>
                            </div>
                            <div class="form-group">
                                <label data-lang-text="ru:Формат даты и времени|en:Date and Time Format"></label>
                                <div class="toggle-switch-group">
                                    <label class="toggle-switch">
                                        <input type="radio" name="timeFormat" value="24h" checked>
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label" data-lang-text="ru:24ч|en:24h"></span>
                                    <label class="toggle-switch">
                                        <input type="radio" name="timeFormat" value="12h">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label" data-lang-text="ru:12ч|en:12h"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label data-lang-text="ru:Язык интерфейса|en:Interface Language"></label>
                                <select id="interfaceLanguage">
                                    <option value="ru" data-lang-text="ru:Русский|en:Russian"></option>
                                    <option value="en" data-lang-text="ru:English|en:English"></option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label data-lang-text="ru:Тема оформления|en:Theme"></label>
                                <div class="toggle-switch-group">
                                    <label class="toggle-switch">
                                        <input type="radio" name="theme" value="light" checked>
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label" data-lang-text="ru:Светлая|en:Light"></span>
                                    <label class="toggle-switch">
                                        <input type="radio" name="theme" value="dark">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="toggle-label" data-lang-text="ru:Тёмная|en:Dark"></span>
                                </div>
                            </div>
                        </div>
                        <div id="profile-history-section" class="profile-section">
                            <h2><span data-lang-text="ru:История авторизаций|en:Authorization History"></span></h2>
                            <div class="form-actions" style="justify-content: flex-end;">
                                <button id="clearHistoryBtn" class="btn btn-secondary" data-lang-text="ru:Очистить историю|en:Clear History"></button>
                            </div>
                            <div class="table-responsive">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th><span data-lang-text="ru:Дата и время|en:Date & Time"></span></th>
                                            <th><span data-lang-text="ru:IP-адрес|en:IP Address"></span></th>
                                            <th><span data-lang-text="ru:Город/регион|en:City/Region"></span></th>
                                            <th><span data-lang-text="ru:Статус|en:Status"></span></th>
                                            <th><span data-lang-text="ru:Причина|en:Reason"></span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="loginHistoryTableBody">
                                        <!-- Данные будут генерироваться JavaScript'ом -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Кнопки Сохранить/Отменить теперь внутри .profile-content -->
                        <div class="profile-actions form-actions">
                            <button id="saveProfileBtn" class="btn btn-primary" data-lang-text="ru:Сохранить|en:Save" disabled></button>
                            <button id="cancelProfileBtn" class="btn btn-secondary" data-lang-text="ru:Отменить|en:Cancel"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Elements ---
        const menuItems = document.querySelectorAll('.main-menu-item');
        const pageAreas = document.querySelectorAll('.page-area');
        const widgetArea = document.querySelector('.widget-area');
        const profilePage = document.getElementById('profile-page');
        const profileSettingsBtn = document.getElementById('profile-settings-btn');
        const themeSwitch = document.querySelector('.theme-switch');
        const contextNav = document.querySelector('.context-nav');
        const breadcrumbs = document.getElementById('breadcrumbs');
        const tileNavigation = document.getElementById('tile-navigation');
        const widgetDetailArea = document.getElementById('widget-detail-area');
        const widgets = document.querySelectorAll('.widget');
        const langSwitcher = document.getElementById('lang-switcher');
        const langIcon = document.getElementById('lang-icon');
        
        // Profile Page Elements
        const interfaceLanguageSelect = document.getElementById('interfaceLanguage');
        const themeRadios = document.querySelectorAll('input[name="theme"]');
        const profileForm = document.querySelector('#profile-main-data-section');
        const interfaceForm = document.querySelector('#profile-interface-section');
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        const cancelProfileBtn = document.getElementById('cancelProfileBtn');

        // --- State ---
        let monitoringIntervalId = null;
        let initialFormState = {};

        // --- Translations ---
        const translations = {};
        document.querySelectorAll('[data-lang-text], [data-lang-placeholder]').forEach(el => {
            const key = el.dataset.langText || el.dataset.langPlaceholder;
            const parts = key.split('|');
            translations[key] = { ru: parts[0].substring(3), en: parts[1].substring(3) };
        });

        // --- Functions ---
        function updateLanguage(lang) {
            if (!lang) return;
            langIcon.setAttribute('icon', lang === 'ru' ? 'emojione:flag-for-russia' : 'emojione:flag-for-united-kingdom');
            document.body.setAttribute('data-lang', lang);
            document.querySelectorAll('[data-lang-text]').forEach(el => {
                const key = el.dataset.langText;
                const target = el.querySelector('span') || el;
                if(target && translations[key] && translations[key][lang] !== undefined) {
                     if (el.tagName === 'LABEL' || !target.matches('span')) {
                        el.innerHTML = translations[key][lang];
                    } else {
                        target.innerHTML = translations[key][lang];
                    }
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                 if (el.dataset.langPlaceholder && translations[el.dataset.langPlaceholder] && translations[el.dataset.langPlaceholder][lang] !== undefined) {
                    el.setAttribute('placeholder', translations[el.dataset.langPlaceholder][lang]);
                }
            });
            if(interfaceLanguageSelect) {
                interfaceLanguageSelect.value = lang;
            }
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
                themeSwitch.classList.add('active');
            } else {
                document.body.classList.remove('dark-mode');
                themeSwitch.classList.remove('active');
            }
            const themeRadio = document.querySelector(`input[name="theme"][value="${theme}"]`);
            if (themeRadio) {
                themeRadio.checked = true;
            }
        }

        function stopMonitoring() {
            if (monitoringIntervalId) {
                clearInterval(monitoringIntervalId);
                monitoringIntervalId = null;
            }
        }

        function startMonitoringUpdates() {
            stopMonitoring();
            
            monitoringIntervalId = setInterval(() => {
                const cpuProgress = document.querySelector('.monitor-widget.cpu .progress');
                const cpuText = document.querySelector('.monitor-widget.cpu p');
                const memProgress = document.querySelector('.monitor-widget.memory .progress');
                const memText = document.querySelector('.monitor-widget.memory p');
                const netIn = document.querySelector('.monitor-widget.network .network-in');
                const netOut = document.querySelector('.monitor-widget.network .network-out');

                if(cpuProgress && cpuText) {
                    const newCpu = Math.floor(Math.random() * 15) + 55;
                    cpuProgress.style.width = newCpu + '%';
                    cpuText.textContent = newCpu + '%';
                }
                if(memProgress && memText) {
                    const newMem = Math.floor(Math.random() * 10) + 35;
                    memProgress.style.width = newMem + '%';
                    memText.textContent = `${newMem}% (${(newMem * 0.2).toFixed(1)}GB / 20GB)`;
                }
                if(netIn && netOut) {
                    const newIn = (Math.random() * 5 + 12).toFixed(1);
                    const newOut = (Math.random() * 2 + 1.5).toFixed(1);
                    netIn.textContent = newIn + ' MB/s';
                    netOut.textContent = newOut + ' MB/s';
                }
            }, 2000);
        }
        
        function showPage(pageToShow) {
            stopMonitoring();
            pageAreas.forEach(page => page.classList.remove('active'));
            pageToShow.classList.add('active');

            if (pageToShow === widgetArea) {
                contextNav.style.display = 'none';
            } else if (pageToShow === profilePage) {
                menuItems.forEach(item => item.classList.remove('active'));
            }
        }
        
        function showWidgetDetail(widgetElement) {
            stopMonitoring();

            const clickedWidgetText = widgetElement.querySelector('p').textContent;
            const widgetGroup = widgetElement.closest('.widget-group');
            const widgetGroupId = widgetGroup.id;
            const sectionMenuItem = document.querySelector(`.main-menu-item[data-target="${widgetGroupId}"]`);
            const sectionName = sectionMenuItem.querySelector('.title').textContent;

            breadcrumbs.innerHTML = `<a href="#" id="home-breadcrumb">Главная</a> <span>/</span> <a href="#" class="breadcrumb-section" data-target="${widgetGroupId}">${sectionName}</a> <span>/</span> <span>${clickedWidgetText}</span>`;
            contextNav.style.display = 'flex';

            tileNavigation.innerHTML = '';
            widgetGroup.querySelectorAll('.widget').forEach(sibling => {
                const siblingText = sibling.querySelector('p').textContent;
                const navItem = document.createElement('div');
                navItem.classList.add('tile-nav-item');
                if (siblingText === clickedWidgetText) {
                    navItem.classList.add('active');
                }
                navItem.textContent = siblingText;
                tileNavigation.appendChild(navItem);
            });

            pageAreas.forEach(page => page.classList.remove('active'));
            widgetDetailArea.classList.add('active');

            if (clickedWidgetText === 'Мониторинг' || clickedWidgetText === 'Monitoring') {
                widgetDetailArea.innerHTML = `
                    <h2>${clickedWidgetText}</h2>
                    <div class="monitoring-dashboard">
                        <div class="monitor-widget cpu"><h3>CPU Load</h3><div class="progress-bar"><div class="progress" style="width: 65%;"></div></div><p>65%</p></div>
                        <div class="monitor-widget memory"><h3>Memory Usage</h3><div class="progress-bar"><div class="progress" style="width: 40%;"></div></div><p>40% (8GB / 20GB)</p></div>
                        <div class="monitor-widget network"><h3>Network Traffic</h3><div class="network-stats"><p><strong>In:</strong> <span class="network-in">15.2 MB/s</span></p><p><strong>Out:</strong> <span class="network-out">2.8 MB/s</span></p></div></div>
                        <div class="monitor-widget disk"><h3>Disk I/O</h3><div class="progress-bar"><div class="progress" style="width: 15%;"></div></div><p>15%</p></div>
                    </div>`;
                startMonitoringUpdates();
            } else {
                widgetDetailArea.innerHTML = `<h2>${clickedWidgetText}</h2><p>Здесь будет подробное содержимое для виджета "${clickedWidgetText}".</p>`;
            }
        }

        // --- Initial Load ---
        const initialTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(initialTheme);
        localStorage.setItem('theme', initialTheme);

        const initialLang = localStorage.getItem('lang') || 'ru';
        updateLanguage(initialLang);
        localStorage.setItem('lang', initialLang);

        // --- Event Listeners ---
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                menuItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                const targetId = this.dataset.target;
                document.querySelectorAll('.widget-group').forEach(group => {
                    group.classList.toggle('active', group.id === targetId);
                });
                showPage(widgetArea);
            });
        });
        
        widgets.forEach(widget => {
            widget.addEventListener('click', () => showWidgetDetail(widget));
        });

        tileNavigation.addEventListener('click', (e) => {
            if (e.target.classList.contains('tile-nav-item')) {
                const widgetText = e.target.textContent;
                const activeMenuItem = document.querySelector('.main-menu-item.active');
                if (!activeMenuItem) return;
                const activeWidgetGroup = activeMenuItem.dataset.target;
                const group = document.getElementById(activeWidgetGroup);
                if (group) {
                    const targetWidget = Array.from(group.querySelectorAll('.widget')).find(w => w.querySelector('p').textContent === widgetText);
                    if(targetWidget) showWidgetDetail(targetWidget);
                }
            }
        });
        
        breadcrumbs.addEventListener('click', (e) => {
            e.preventDefault();
            if (e.target.id === 'home-breadcrumb') {
                 const firstMenuItem = document.querySelector('.main-menu-item[data-target="dashboards-widgets"]');
                 if(firstMenuItem) firstMenuItem.click();
            } else if (e.target.classList.contains('breadcrumb-section')) {
                const targetId = e.target.dataset.target;
                const targetMenuItem = document.querySelector(`.main-menu-item[data-target="${targetId}"]`);
                if (targetMenuItem) targetMenuItem.click();
            }
        });

        profileSettingsBtn.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.popup-menu.visible').forEach(p => p.classList.remove('visible'));
            showPage(profilePage);
        });

        themeSwitch.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        });

        langSwitcher.addEventListener('click', () => {
            const newLang = document.body.getAttribute('data-lang') === 'ru' ? 'en' : 'ru';
            updateLanguage(newLang);
            localStorage.setItem('lang', newLang);
        });

        // --- Global Widget Search ---
        const searchInput = document.getElementById('page-search');
        const searchResultsContainer = document.getElementById('search-results');
        const allWidgets = Array.from(document.querySelectorAll('.widget'));

        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.toLowerCase().trim();
            searchResultsContainer.innerHTML = '';

            if (searchTerm.length < 2) { // Start searching from 2 characters
                searchResultsContainer.style.display = 'none';
                return;
            }

            const matchedWidgets = allWidgets.filter(widget => {
                const textElement = widget.querySelector('p');
                return textElement.textContent.toLowerCase().includes(searchTerm);
            });

            if (matchedWidgets.length > 0) {
                matchedWidgets.forEach(widget => {
                    const widgetText = widget.querySelector('p').textContent;
                    const widgetIcon = widget.querySelector('iconify-icon').getAttribute('icon');
                    const widgetGroup = widget.closest('.widget-group');
                    const widgetGroupId = widgetGroup.id;
                    const sectionMenuItem = document.querySelector(`.main-menu-item[data-target="${widgetGroupId}"]`);
                    const sectionName = sectionMenuItem.querySelector('.title').textContent;

                    const resultItem = document.createElement('div');
                    resultItem.classList.add('search-result-item');
                    resultItem.dataset.widgetText = widgetText;
                    resultItem.dataset.widgetGroup = widgetGroupId;

                    resultItem.innerHTML = `
                        <iconify-icon icon="${widgetIcon}"></iconify-icon>
                        <div>
                            <p>${widgetText}</p>
                            <span>${sectionName}</span>
                        </div>
                    `;
                    searchResultsContainer.appendChild(resultItem);
                });
                searchResultsContainer.style.display = 'block';
            } else {
                searchResultsContainer.style.display = 'none';
            }
        });

        searchResultsContainer.addEventListener('click', (e) => {
            const resultItem = e.target.closest('.search-result-item');
            if (!resultItem) return;

            const widgetText = resultItem.dataset.widgetText;
            const widgetGroupId = resultItem.dataset.widgetGroup;

            const targetMenuItem = document.querySelector(`.main-menu-item[data-target="${widgetGroupId}"]`);
            if (targetMenuItem) {
                targetMenuItem.click();
            }

            const targetWidget = allWidgets.find(w => 
                w.querySelector('p').textContent === widgetText && 
                w.closest('.widget-group').id === widgetGroupId
            );

            if (targetWidget) {
                showWidgetDetail(targetWidget);
            }

            searchInput.value = '';
            searchResultsContainer.innerHTML = '';
            searchResultsContainer.style.display = 'none';
        });
        
        // --- Popups ---
        setupPopup('bell-icon', 'notification-popup');
        setupPopup('user-avatar', 'profile-dropdown');
        
        function setupPopup(triggerId, popupId) {
            const trigger = document.getElementById(triggerId);
            const popup = document.getElementById(popupId);
            if (!trigger || !popup) return;
            
            trigger.addEventListener('click', (event) => {
                event.stopPropagation();
                document.querySelectorAll('.popup-menu.visible').forEach(p => {
                    if (p.id !== popupId) p.classList.remove('visible');
                });
                popup.classList.toggle('visible');
            });
        }
        
        document.addEventListener('click', (e) => {
             document.querySelectorAll('.popup-menu.visible').forEach(p => p.classList.remove('visible'));
             const searchResultsContainer = document.getElementById('search-results');
             // Hide search results when clicking outside
             if (searchResultsContainer && !e.target.closest('.search-bar-container')) {
                searchResultsContainer.style.display = 'none';
            }
        });

        // --- Profile Page Logic (IIFE to avoid global scope pollution) ---
        (function () {
            if (!profilePage) return; // Don't run if profile page elements aren't there

            const profileMenuItems = document.querySelectorAll('.profile-menu-item');
            const profileSections = document.querySelectorAll('.profile-section');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const passwordChangeForm = document.getElementById('passwordChangeForm');
            const newPasswordInput = document.getElementById('newPassword');
            const passwordStrengthIndicator = document.querySelector('.password-strength-indicator');
            const cancelPasswordChangeBtn = passwordChangeForm.querySelector('.btn-secondary');

            // --- Profile Tabs Navigation ---
            profileMenuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    profileMenuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    profileSections.forEach(section => section.classList.remove('active'));
                    const targetSection = document.getElementById(this.dataset.target);
                    if (targetSection) {
                        targetSection.classList.add('active');
                    }
                });
            });

            // --- Change Password Logic ---
            changePasswordBtn.addEventListener('click', () => {
                passwordChangeForm.classList.toggle('hidden');
            });

            cancelPasswordChangeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                passwordChangeForm.classList.add('hidden');
            });
            
            function checkPasswordStrength(password) {
                let strength = 0;
                if (password.length >= 8) strength++;
                if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
                if (/\d/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                return strength;
            }

            newPasswordInput.addEventListener('input', () => {
                const password = newPasswordInput.value;
                const strength = checkPasswordStrength(password);
                const bars = passwordStrengthIndicator.querySelectorAll('.strength-bar');
                bars.forEach((bar, index) => {
                    bar.className = 'strength-bar';
                    if (password.length > 0 && index < strength) {
                        if (strength <= 1) bar.classList.add('weak');
                        else if (strength <= 3) bar.classList.add('medium');
                        else bar.classList.add('strong');
                    }
                });
            });


            // --- Save/Cancel Logic ---
            function saveInitialFormState() {
                initialFormState = {
                    email: document.getElementById('email').value,
                    homeDashboard: document.getElementById('homeDashboard').value,
                    widgetLimit: document.getElementById('widgetLimit').value,
                    timeZone: document.getElementById('timeZone').value,
                    timeFormat: document.querySelector('input[name="timeFormat"]:checked').value,
                    interfaceLanguage: interfaceLanguageSelect.value,
                    theme: document.querySelector('input[name="theme"]:checked').value,
                };
            }

            function hasFormChanged() {
                return initialFormState.email !== document.getElementById('email').value ||
                    initialFormState.homeDashboard !== document.getElementById('homeDashboard').value ||
                    initialFormState.widgetLimit !== document.getElementById('widgetLimit').value ||
                    initialFormState.timeZone !== document.getElementById('timeZone').value ||
                    initialFormState.timeFormat !== document.querySelector('input[name="timeFormat"]:checked').value ||
                    initialFormState.interfaceLanguage !== interfaceLanguageSelect.value ||
                    initialFormState.theme !== document.querySelector('input[name="theme"]:checked').value;
            }

            function toggleSaveButton() {
                saveProfileBtn.disabled = !hasFormChanged();
            }
            
            [profileForm, interfaceForm].forEach(form => {
                form.addEventListener('input', toggleSaveButton);
                form.addEventListener('change', toggleSaveButton);
            });

            saveProfileBtn.addEventListener('click', () => {
                alert('Настройки профиля сохранены!');
                saveInitialFormState(); 
                toggleSaveButton(); 
            });

            cancelProfileBtn.addEventListener('click', () => {
                // Reset values from stored state
                document.getElementById('email').value = initialFormState.email;
                document.getElementById('homeDashboard').value = initialFormState.homeDashboard;
                document.getElementById('widgetLimit').value = initialFormState.widgetLimit;
                document.getElementById('timeZone').value = initialFormState.timeZone;
                document.querySelector(`input[name="timeFormat"][value="${initialFormState.timeFormat}"]`).checked = true;
                
                // Resync global state for language and theme
                updateLanguage(initialFormState.interfaceLanguage);
                applyTheme(initialFormState.theme);

                toggleSaveButton();
                alert('Изменения отменены.');
            });
            
            // Initial state
            saveInitialFormState();
            toggleSaveButton();


            // --- Authorization History Logic ---
            const loginHistoryTableBody = document.getElementById('loginHistoryTableBody');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const isAdmin = true; // Mock admin role

            if (!isAdmin) {
                clearHistoryBtn.classList.add('hidden');
            }

            function generateLoginHistoryData(count = 10) {
                const data = [];
                const statuses = ['Успешно', 'Неудача'];
                const reasons = ['Неверный пароль', 'Блокировка аккаунта', ''];
                const cities = ['Москва', 'Санкт-Петербург', 'Нью-Йорк', 'Токио', 'Лондон'];

                for (let i = 0; i < count; i++) {
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    const reason = (status === 'Неудача') ? reasons[Math.floor(Math.random() * reasons.length)] : '';
                    const date = new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000);
                    data.push({
                        dateTime: date.toLocaleString(document.body.dataset.lang),
                        ipAddress: `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`,
                        cityRegion: cities[Math.floor(Math.random() * cities.length)],
                        status: status,
                        reason: reason
                    });
                }
                return data.sort((a, b) => new Date(b.dateTime).getTime() - new Date(a.dateTime).getTime());
            }

            let loginHistory = generateLoginHistoryData();

            function renderLoginHistoryTable() {
                if (!loginHistoryTableBody) return;
                loginHistoryTableBody.innerHTML = '';
                loginHistory.forEach(entry => {
                    const row = loginHistoryTableBody.insertRow();
                    if (entry.status === 'Неудача') {
                        row.classList.add('failed-login');
                    }
                    row.insertCell().textContent = entry.dateTime;
                    row.insertCell().textContent = entry.ipAddress;
                    row.insertCell().textContent = entry.cityRegion;
                    row.insertCell().textContent = entry.status;
                    row.insertCell().textContent = entry.reason;
                });
            }

            clearHistoryBtn.addEventListener('click', () => {
                if (confirm('Вы уверены, что хотите очистить историю авторизаций?')) {
                    loginHistory = [];
                    renderLoginHistoryTable();
                    alert('История очищена (фиктивно).');
                }
            });

            // Initial render
            renderLoginHistoryTable();

            // --- Listeners for controls already in the IIFE ---
            if (interfaceLanguageSelect) {
                interfaceLanguageSelect.addEventListener('change', (e) => {
                    updateLanguage(e.target.value);
                    localStorage.setItem('lang', e.target.value);
                });
            }

            if (themeRadios.length) {
                themeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        applyTheme(e.target.value);
                        localStorage.setItem('theme', e.target.value);
                    });
                });
            }
        })();
    });
</script>
</body>
</html>